<!doctype html>

<html lang="en">
<head>
	<meta charset="utf-8">

	<title>Identicon</title>
	<meta name="description" content="The HTML5 Herald">
	<meta name="author" content="SitePoint">

	<style>
		* {
			box-sizing: border-box;
		}

		body {
			width: 100%;
			height: 100%;
			background: #f2f3f4;
		}

		#canvas {
			/*border: 1px solid lightgray;*/
			/*background: #FFF3F3;*/
			background: white;
			/*width: 250px;*/
			/*height: 250px;*/
			margin: 50px;
		}
	</style>

	<script src="sha1.js"></script>
	<script src="sha2.js"></script>
	<script src="paper-full.min.js"></script>

	<script defer>

	window.onload = function() {
		// Get a reference to the canvas object
		var canvas = document.querySelector('#canvas');
		canvas.width = 500;
		canvas.height = 500;

		var scale = canvas.width / 100;

		// Create an empty project and a view for the canvas:
		paper.setup(canvas);

		var position = 0; // Position along hashed binary string
		var hash = strToBinArr(String(Math.floor(Math.random() * 500)));
		// var hash = strToBinArr('terrykwon');

		var getParam = function(bits) {
			bitArr = hash.slice(position, position+bits);
			position += bits;
			return binArrToInt(bitArr);	
		}

		let trunkFrom = new paper.Point(42*scale, 100*scale);
		let trunkTo = new paper.Point(58*scale, 80*scale);
		let trunk = new paper.Shape.Rectangle(trunkFrom, trunkTo);
		trunk.fillColor = '#53474188';

		let baseY = 80 * scale;
		let cellSize = 10;

		for (let level = 0; level < 6; level++) {
			let numLeaves = getParam(2) + (6-level);

			let baseX = ((100 - (cellSize*numLeaves) + cellSize) / 2) * scale;

			let shapeType = getParam(2);

			let r = Math.floor(getParam(4) / 16 * 128);
			let g = Math.floor(getParam(4) / 16 * 128) + 128;
			let b = Math.floor(getParam(4) / 16 * 164);

			let h = (getParam(4) / 16 * 100 + 55) / 360;
			let s = 0.8;
			let l = 0.5;

			let rgb = hslToRgb(h, s, l);
			console.log(rgb);
			r = rgb[0];
			g = rgb[1];
			b = rgb[2];

			for (let i = 0; i < numLeaves; i++) {
				let leafCenter = new paper.Point(baseX, baseY);

				let leaf;

				let shapeSize = 0.8;
				if (shapeType == 0) {
					leaf = new paper.Shape.Circle(leafCenter, cellSize*scale*shapeSize*0.9);
				} else if (shapeType == 1) {
					// let leafLeftCorner = new paper.Point(baseX-(cellSize*0.6/2)*scale, baseY-(cellSize*0.6/2)*scale);
					// leaf = new paper.Shape.Rectangle(leafLeftCorner, cellSize*scale*0.6);
					leaf = new paper.Path.RegularPolygon(leafCenter, 6, cellSize*scale*shapeSize);
				} else if (shapeType == 2) {
					leaf = new paper.Path.RegularPolygon(leafCenter, 3, cellSize*scale*shapeSize*1.1);
				} else {
					leaf = new paper.Path.RegularPolygon(leafCenter, 5, cellSize*scale*shapeSize);
				}

				leaf.fillColor = `rgba(${r}, ${g}, ${b}, 0.6)`;
				baseX += cellSize * scale;
			}

			baseY -= 12*scale;
		}

		paper.view.draw();
	}

	var binArrToInt = function(arr) {
		let pos = 0;
		let res = 0;

		for (let b of arr) {
			res += b << pos;
			pos += 1;
		}

		return res;
	}

	var strToBinArr = function(string) {
		let hashed = sha1.array(string);
		// let hashed = sha256(string);
		let arr = Array();
		console.log(hashed);

		for (let i of hashed) {
			console.log(i);
			let byte = i;
			for (let j = 0; j < 8; j++) {
				bit = (byte >> j) & 1;
				arr.push(bit);
			}
		}

		return arr.concat(arr).concat(arr).concat(arr);
	}

	/**
	 * Converts an HSL color value to RGB. Conversion formula
	 * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
	 * Assumes h, s, and l are contained in the set [0, 1] and
	 * returns r, g, and b in the set [0, 255].
	 *
	 * @param   {number}  h       The hue
	 * @param   {number}  s       The saturation
	 * @param   {number}  l       The lightness
	 * @return  {Array}           The RGB representation
	 */
	function hslToRgb(h, s, l){
	    var r, g, b;

	    if(s == 0){
	        r = g = b = l; // achromatic
	    }else{
	        var hue2rgb = function hue2rgb(p, q, t){
	            if(t < 0) t += 1;
	            if(t > 1) t -= 1;
	            if(t < 1/6) return p + (q - p) * 6 * t;
	            if(t < 1/2) return q;
	            if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
	            return p;
	        }

	        var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
	        var p = 2 * l - q;
	        r = hue2rgb(p, q, h + 1/3);
	        g = hue2rgb(p, q, h);
	        b = hue2rgb(p, q, h - 1/3);
	    }

	    return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
	}

	</script>

</head>

<body>
	<!-- <h1>Parametric animations</h1> -->

	<canvas id="canvas">
	</canvas>

	<!-- <canvas id="canvas" width=500 height-500></canvas> -->

</body>

</html>